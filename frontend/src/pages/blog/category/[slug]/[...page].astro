---
// src/pages/blog/[slug]/[page].astro or similar
import Layout from "@/layouts/Layout.astro";
import BlogLayout from "@/components/BlogLayout.astro";

import { getBlogIndexData } from "@/utils/getBlogIndexData";
import { getCategorySlugs } from "@/utils/sanityQueries";

export async function getStaticPaths({ paginate }) {
  const slugs = await getCategorySlugs();
  const paths = [];

  for (const { slug } of slugs) {
    const { posts } = await getBlogIndexData({ slug });
    const paginated = paginate(posts, {
      pageSize: 9,
      params: { slug },
    });
    paths.push(...paginated);
  }

  return paths;
}

const { slug } = Astro.params;
const { page } = Astro.props;

const SITE_URL = import.meta.env.PUBLIC_SITE_URL;
const canonicalPath = `/blog/${slug}`;
const canonicalUrl = `${SITE_URL}${canonicalPath}`;

const { categories } = await getBlogIndexData({});
const category = categories.find((cat) => cat.slug === slug);

const pageTitle = category?.title ?? "Blog Category";
const pageDescription = category?.description ?? "Articles under this category";
---

<Layout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  canonicalPath={canonicalPath}
  openGraphImage="/imgs/default-og-image.png"
>
  <BlogLayout
    posts={page.data}
    categories={categories}
    categorySlug={slug}
    prevUrl={page.url.prev}
    nextUrl={page.url.next}
    currentPage={page.currentPage}
    lastPage={page.lastPage}
  />
</Layout>
