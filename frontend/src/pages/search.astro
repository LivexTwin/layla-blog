---
import Layout from "../layouts/Layout.astro";
import Icon from "../components/Icon.astro";
import CategoryFilterList from "../components/CategoryFilterList.astro";
import { getBlogIndexData } from "../utils/getBlogIndexData";
import "../styles/search.css";

const { categories, categorySlug } = await getBlogIndexData({});

const SITE_URL = import.meta.env.PUBLIC_SITE_URL;
const canonicalPath = "/search";
const canonicalUrl = `${SITE_URL}${canonicalPath}`;
---

<Layout
  pageTitle="Search Blog Posts"
  pageDescription="Search our blog posts by keyword, category, or tag to find content that resonates with you."
  canonicalPath={canonicalPath}
  openGraphImage="/images/og-default.jpg"
>
  <div class="search-page">
    <section class="wrapper">
      <header>
        <h1>
          Find the Support You Need
          <Icon
            name="search"
            title="Search Icon"
            size={48}
            class="search-page__title-icon"
            role="button"
            tabindex="0"
            aria-label="Focus search input"
          />
        </h1>
        <p class="search-page__subtitle">
          Search for blog posts by <span class="search-page__span">keyword</span
          >, <span class="search-page__span">category</span>, or <span
            class="search-page__span">tag</span
          >. Use the search bar below to find content that resonates with you.
        </p>
      </header>

      <div id="search" class="pagefind-ui"></div>
    </section>

    <section class="search-page__categories">
      <CategoryFilterList
        categories={categories}
        categorySlug={categorySlug}
        heading="Search by Category"
        aria-label="Blog categories"
        class="search-page__categories-list"
      />
    </section>
  </div>
</Layout>

<script type="module">
  import "/pagefind/pagefind-ui.js";

  new PagefindUI({
    element: "#search",
    resetStyles: false,
    autofocus: true,
    debounceTimeoutMs: 500,
    excerptLength: 150,
    zero_results: "Couldn't find [SEARCH_TERM]",
    showEmptyFilters: false,
    translations: {
      placeholder: "Search blog posts...",
      zero_results: "Couldn't find [SEARCH_TERM]",
    },
  });

  // Wait for Pagefind to render, then set maxlength + bind icon focus
  setTimeout(() => {
    const input = document.querySelector(".pagefind-ui__search-input");
    const icon = document.querySelector(".search-page__title-icon");

    if (icon) {
      // Focus input on click
      icon.addEventListener("click", () => {
        input.focus();
      });

      // Focus input on Enter or Space key
      icon.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          input.focus();
        }
      });
    }
  }, 100);
</script>

<style>
  .search-page {
    padding-top: var(--spacing-xxl);
  }
  .search-page__categories {
    display: flex;
    justify-content: center;
    margin-bottom: var(--spacing-xl);
  }

  .search-page__title-icon {
    cursor: pointer;
  }

  .search-page__title-icon:hover {
    color: var(--clr-secondary);
    transition: var(--transition-duration);
  }

  .search-page__title-icon:focus-visible {
    outline: none;
    border-radius: var(--border-radius);
    box-shadow: var(--focus-shadow) var(--clr-secondary);
  }
</style>
